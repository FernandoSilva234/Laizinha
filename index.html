<!doctype html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cartilha Viva ‚Äî Obesidade & Sa√∫de Mental</title>
  <meta name="description" content="Material educativo e interativo: rela√ß√£o entre obesidade, sa√∫de mental e h√°bitos saud√°veis. Conte√∫do acess√≠vel, livre de estigma e alinhado a boas pr√°ticas de sa√∫de p√∫blica." />
  <style>
    :root{
      /* ‚öôÔ∏è Dark mais claro e leg√≠vel */
      --bg:#1b2236; --panel:#222e46; --card:#222e46; --line:#334563;
      --text:#ffffff; --muted:#cfd6e3;
      --accent:#22d3ee; --accent2:#60a5fa;
      --good:#22c55e; --warn:#f59e0b; --danger:#ef4444;
      --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.35); --fs:16px;
    }
    /* Tema claro com alto contraste e menos brilho */
    [data-theme="light"]{
      --bg:#f4f7fb; --panel:#ffffff; --card:#ffffff; --line:#d7dee9;
      --text:#0b1224; --muted:#475569; --accent:#0ea5e9; --accent2:#2563eb; --shadow:0 8px 24px rgba(16,24,40,.12)
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial; background:var(--bg); color:var(--text); font-size:var(--fs); line-height:1.55}
    a{color:var(--accent)}
    .container{max-width:1100px;margin-inline:auto;padding:20px}
    header.site{display:flex;gap:12px;justify-content:space-between;align-items:center;padding:14px 16px;border:1px solid var(--line);border-radius:var(--radius);background:var(--panel);box-shadow:var(--shadow);position:sticky;top:10px;z-index:5}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{display:none}
    .uni-logo{width:clamp(220px,34vw,320px);height:80px;border-radius:12px;background:#fff;border:1px solid var(--line);object-fit:contain;padding:6px}
    .title{font-weight:800}
    .sub{color:var(--muted);font-size:.95rem}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    /* Desktop: lado a lado; Mobile: quebra linha */
    @media (min-width:801px){ header.site .actions{flex-wrap:nowrap} }
    @media (max-width:800px){ header.site{flex-wrap:wrap} header.site .actions{flex-wrap:wrap; width:100%; justify-content:flex-start} }
    .btn{cursor:pointer;border:1px solid var(--line);background:var(--card);color:var(--text);padding:10px 14px;border-radius:12px;font-weight:700;transition:transform .12s ease, box-shadow .12s ease}
    .btn:hover{transform:translateY(-1px);box-shadow:var(--shadow)}
    .btn.primary{border-color:transparent;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#06121d}
    .btn.good{border-color:transparent;background:linear-gradient(135deg,#16a34a,#4ade80);color:#05210f}
    main{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;margin-top:16px}
    @media (max-width:920px){main{grid-template-columns:1fr}}
    .card{border:1px solid var(--line);background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .muted{color:var(--muted)}
    h2{margin:0 0 10px}
    /* Tabs ‚Äî texto sempre vis√≠vel no escuro */
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 12px}
    .tab{border:2px solid var(--line);padding:10px 14px;border-radius:999px;background:var(--panel);cursor:pointer;font-weight:800;color:var(--text)}
    .tab[aria-selected="true"]{background:linear-gradient(135deg, var(--accent), var(--accent2)); border-color:transparent; color:#06121d; text-shadow:0 1px 0 rgba(255,255,255,.4)}
    [data-tab]{display:none}
    [data-tab].active{display:block}
    /* Info chips */
    .chip{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:var(--panel);font-weight:700}
    .grid{display:grid;gap:10px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    @media (max-width:720px){.grid.cols-2{grid-template-columns:1fr}}
    .ill{width:100%;max-width:520px;margin-inline:auto;border-radius:14px;border:1px solid var(--line)}
    /* Breathing circle */
    .breath{width:clamp(200px,55vw,320px);height:clamp(200px,55vw,320px);border-radius:50%;border:3px solid var(--accent);display:grid;place-items:center;margin:auto;opacity:.95;font-size:clamp(48px,8vw,96px)}
    .breath[data-active="true"]{animation:breathe 8s ease-in-out infinite}
    @keyframes breathe{0%{transform:scale(1)}50%{transform:scale(1.2)}100%{transform:scale(1)}}
    /* Ring responsive + fallback */
    .ring{--size:clamp(120px,38vw,180px);width:var(--size);height:var(--size);border-radius:50%;background:conic-gradient(var(--accent) calc(var(--p,0)*1%), var(--line) 0);display:grid;place-items:center;position:relative;box-shadow:inset 0 0 0 8px rgba(255,255,255,.03)}
    .ring.no-conic{background:var(--panel);border:8px solid var(--line)}
    .ring-hole{position:absolute;inset:12px;border-radius:50%;background:var(--panel);border:1px solid var(--line)}
    /* Streak */
    .streak{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .dot{aspect-ratio:1;border-radius:10px;border:1px solid var(--line);background:#1f2b45;display:grid;place-items:center;font-size:.8rem;color:#e6edf8;font-weight:800}
    .dot[data-on="true"]{background:linear-gradient(180deg,#0f2f1a,#0b2012);border-color:#37d073;color:#a7f3d0}
    /* QR & print */
    .qr{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .qr img{background:#fff;border-radius:12px;border:2px solid var(--line)}
    .print-only{display:none}
    @media print{
      #confetti,.actions,.tabs,header.site,aside.card,footer.card{display:none!important}
      #intro,#habitos,#respiracao,#recursos{display:none!important}
      #relacoes{display:block!important}
      body{print-color-adjust:exact;-webkit-print-color-adjust:exact;background:#fff;color:#000}
      .print-only{display:block}
      #printFooter{margin-top:16px;border-top:1px solid #d7dee9;padding-top:10px}
      #printFooter .meta{display:flex;justify-content:space-between;align-items:center;gap:10px}
      #printFooter img{display:none}
    }
    /* Confetti */
    #confetti{position:fixed;inset:0;pointer-events:none;z-index:999}
    /* PDF mode hides interactive controls */
    .pdf-mode .actions{display:none!important}
    .pdf-mode #confetti{display:none!important}
  </style>
  <!-- Lottie player para anima√ß√µes leves -->
  <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
  <!-- html2pdf para gerar PDF local a partir do HTML -->
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
</head>
<body>
  <canvas id="confetti"></canvas>
  <div class="container">
    <header class="site" role="banner">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <img id="uniLogo" alt="Unicesumar" class="uni-logo" src="https://fernandosilva234.github.io/Laizinha/UNICESUMAR.jpg" decoding="async" loading="eager" crossorigin="anonymous"/>
        <div>
          <div class="title">Cartilha Viva ‚Äî Obesidade & Sa√∫de Mental</div>
          <div class="sub">Material educativo, acess√≠vel e sem estigma. <span class="muted">N√£o substitui orienta√ß√£o profissional.</span></div>
          <div class="muted" id="autorHeader">Nome: Laize Lemes</div>
        </div>
      </div>
      <div class="actions" role="toolbar" aria-label="Prefer√™ncias">
        <button id="toggle-theme" class="btn">üåì Tema</button>
        <button id="pdf" class="btn">‚¨áÔ∏è PDF</button>
      </div>
    </header>

    <main>
      <!-- Coluna principal: guia educativo com abas -->
      <section class="card">
        <div class="tabs" role="tablist">
          <button class="tab" role="tab" aria-selected="true" data-target="#intro">In√≠cio</button>
          <button class="tab" role="tab" aria-selected="false" data-target="#relacoes">Rela√ß√µes mente-corpo</button>
          <button class="tab" role="tab" aria-selected="false" data-target="#habitos">H√°bitos pr√°ticos</button>
          <button class="tab" role="tab" aria-selected="false" data-target="#respiracao">Pausa & Respira√ß√£o</button>
          <button class="tab" role="tab" aria-selected="false" data-target="#recursos">Recursos confi√°veis</button>
        </div>

        <div id="intro" data-tab class="active">
          <div class="grid cols-2">
            <div>
              <h2>Por que esta cartilha?</h2>
              <p>Obesidade √© uma <b>DCNT multifatorial</b>. Al√©m de alimenta√ß√£o e movimento, aspectos de <b>sa√∫de mental</b> e do <b>neurodesenvolvimento</b> podem influenciar apetite, impulsividade, planejamento e autocuidado. Este material oferece <b>informa√ß√£o p√∫blica</b> em linguagem simples, para apoiar escolhas e incentivar acompanhamento multiprofissional.</p>
              <div class="chip">üß≠ Diretriz: educa√ß√£o em sa√∫de ‚Ä¢ linguagem sem estigma</div>
              <p class="muted">Metodologia: revis√£o narrativa em psicologia, nutri√ß√£o, psiquiatria e sa√∫de p√∫blica. Produto: cartilha com QR Code para acesso digital.</p>
            </div>
            <div>
              <lottie-player class="ill" src="https://assets10.lottiefiles.com/packages/lf20_tutvdkg0.json" background="transparent" speed="1" loop autoplay></lottie-player>
            </div>
          </div>
          <hr style="border-color:var(--line);margin:16px 0"/>
          <div class="qr">
            <a id="qrLink" href="#" target="_blank" rel="noopener">
              <img id="qr" alt="QR Code para esta cartilha" width="120" height="120"/>
            </a>
            <div>
              <b>Leve com voc√™</b>
              <p class="muted">Use o QR no folder f√≠sico para acessar esta vers√£o digital sempre que quiser.</p>
              <div class="actions" style="margin-top:6px">
                <a id="openPageBtn" class="btn" href="#" target="_blank" rel="noopener">üîó Abrir p√°gina</a>
              </div>
            </div>
          </div>
        </div>

        <div id="relacoes" data-tab>
          <h2>Como transtornos podem influenciar h√°bitos</h2>
          <p class="muted">Informa√ß√£o <b>n√£o diagn√≥stica</b>. Se identificar sinais, procure uma equipe (psicologia, nutri√ß√£o, medicina, educa√ß√£o f√≠sica).</p>
          <div class="grid cols-2">
            <div class="card">
              <h3>üß† TDAH</h3>
              <p>Impulsividade e dificuldade de organiza√ß√£o podem afetar <b>planejamento de refei√ß√µes</b> e const√¢ncia em exerc√≠cios. Estrat√©gias: rotinas curtas, alarmes e <b>passos de 5‚Äì10 minutos</b>.</p>
            </div>
            <div class="card">
              <h3>üß© TEA</h3>
              <p>Prefer√™ncias sensoriais e rotinas r√≠gidas podem influenciar <b>variedade alimentar</b> e ades√£o. Estrat√©gias: previsibilidade, quadros visuais e trocas graduais.</p>
            </div>
            <div class="card">
              <h3>üíú Personalidade Borderline</h3>
              <p>Oscila√ß√µes emocionais podem levar a <b>comer emocional</b>. Estrat√©gias: t√©cnicas de <b>regula√ß√£o</b> (respira√ß√£o, pausa) e planejamento de suporte.</p>
            </div>
            <div class="card">
              <h3>üåø Esquizofrenia</h3>
              <p>Alguns antipsic√≥ticos podem aumentar apetite e peso. Estrat√©gias: acompanhamento nutricional, rotina de sono, caminhada leve e <b>suporte multiprofissional</b>.</p>
            </div>
          </div>
        </div>

        <div id="habitos" data-tab>
          <h2>H√°bitos pr√°ticos (comece pequeno)</h2>
          <p class="muted">Ferramentas simples para criar <b>consist√™ncia</b>. Dados ficam somente no seu navegador (localStorage).</p>
          <div class="grid cols-2">
            <div class="card">
              <h3>üéØ Meta di√°ria</h3>
              <p>Defina uma meta breve de movimento (ex.: <b>10 min</b>). Use o timer e some pontos.</p>
              <div class="chip">Dica: melhor feito que perfeito</div>
              <div style="margin-top:8px">
                <label for="goalInput" class="muted">Minutos/dia</label>
                <input id="goalInput" type="number" min="5" max="120" value="10" style="width:90px;background:transparent;color:var(--text);border:1px solid var(--line);border-radius:10px;padding:8px"/>
                <button id="celebrateDemo" class="btn">‚ú® Testar confete</button>
              </div>
              <div style="display:flex;gap:10px;align-items:center;margin-top:10px">
                <div id="ring" class="ring" style="--p:0">
                  <div class="ring-hole"></div>
                  <div style="position:relative;font-weight:800"><span id="minutesDone">0</span> min</div>
                </div>
                <div>
                  <div class="chip">Meta: <b id="goal">10</b> min</div>
                  <div class="streak" id="streak" style="margin-top:8px"></div>
                </div>
              </div>
            </div>
            <div class="card">
              <h3>‚úÖ Rotina guiada</h3>
              <div class="grid">
                <div class="card" style="padding:10px">
                  <b>üßä Aquecimento</b> ‚Äî 2 min
                  <div class="chip" style="margin-top:6px"><button class="btn start" data-min="2" data-label="Aquecimento">Iniciar</button><span class="muted" data-role="timer">00:00</span></div>
                </div>
                <div class="card" style="padding:10px">
                  <b>üö∂ Caminhada r√°pida</b> ‚Äî 5 min
                  <div class="chip" style="margin-top:6px"><button class="btn start" data-min="5" data-label="Caminhada">Iniciar</button><span class="muted" data-role="timer">00:00</span></div>
                </div>
                <div class="card" style="padding:10px">
                  <b>üßò Alongamento</b> ‚Äî 3 min
                  <div class="chip" style="margin-top:6px"><button class="btn start" data-min="3" data-label="Alongamento">Iniciar</button><span class="muted" data-role="timer">00:00</span></div>
                </div>
              </div>
              <div class="actions" id="controls" style="margin-top:8px;display:none">
                <button class="btn" id="pause">‚è∏Ô∏è Pausar</button>
                <button class="btn" id="resume">‚ñ∂Ô∏è Continuar</button>
                <button class="btn" id="cancel">‚úñÔ∏è Cancelar</button>
              </div>
            </div>
          </div>

          <div class="card" style="margin-top:12px">
            <h3>üçΩÔ∏è Alimenta√ß√£o gentil</h3>
            <ul>
              <li>Monte um <b>prato simples</b>: ¬Ω verduras/legumes, ¬º prote√≠nas, ¬º carboidratos.</li>
              <li>Trocas graduais: incluir 1 fruta/dia, √°gua √† vista, reduzir ultraprocessados.</li>
              <li>Planeje <b>lanchinhos</b> pr√°ticos para evitar longos jejuns.</li>
            </ul>
          </div>
        </div>

        <div id="respiracao" data-tab>
          <h2>Pausa de 1 minuto ‚Äî Respira√ß√£o box 4‚Äì4‚Äì4‚Äì4</h2>
          <p class="muted">Recurso de <b>regula√ß√£o emocional</b> ‚Äî √∫til para comer com mais consci√™ncia e iniciar movimentos curtos.</p>
          <div class="breath" id="breath">ü´Å</div>
          <div class="actions" style="justify-content:center;margin-top:10px">
            <button class="btn" id="breathToggle">üßò Iniciar</button>
          </div>
        </div>

        <div id="recursos" data-tab>
          <h2>Onde buscar apoio confi√°vel</h2>
          <ul>
            <li><b>Emerg√™ncia no Brasil:</b> SAMU <b>192</b>. Apoio emocional: <b>CVV 188</b> (24h, gratuito).</li>
            <li><b>SUS/UBS</b>: procure a unidade b√°sica de sa√∫de para encaminhamento multiprofissional.</li>
            <li>Diretrizes e materiais (acesso p√∫blico):
              <ul>
                <li>Organiza√ß√£o Mundial da Sa√∫de (OMS/WHO) ‚Äî preven√ß√£o de DCNT.</li>
                <li>Minist√©rio da Sa√∫de ‚Äî Guias de Alimenta√ß√£o e Atividade F√≠sica.</li>
              </ul>
            </li>
          </ul>
          <p class="muted"><b>Aviso:</b> Este site √© educativo e n√£o realiza diagn√≥stico, prescri√ß√£o ou acompanhamento cl√≠nico.</p>
        </div>
      </section>

      <!-- Coluna lateral: notas do projeto e cr√©dito/QR -->
      <aside class="card">
        <h2>Sobre o projeto</h2>
        <p>Cartilha informativa baseada em <b>revis√£o narrativa</b> (psicologia, nutri√ß√£o, psiquiatria e sa√∫de p√∫blica). Objetivo: ampliar a compreens√£o da obesidade de forma <b>interdisciplinar</b> e <b>sem estigma</b>, promovendo autocuidado e busca por acompanhamento multiprofissional.</p>
        <hr style="border-color:var(--line);margin:12px 0"/>
        <h3>Cr√©ditos</h3>
        <p class="muted">Autoria acad√™mica (Psicologia): <span id="autor">Laize Lemes</span>. Desenvolvimento: p√°gina web interativa acess√≠vel.</p>
        <div class="chip">üì© Contato institucional / Orienta√ß√£o</div>
        <hr style="border-color:var(--line);margin:12px 0"/>
        <h3>Rela√ß√µes mente-corpo</h3>
        <div class="qr">
          <a id="qrLink2" href="#" target="_blank" rel="noopener">
            <img id="qr2" alt="QR Code alternativo" width="120" height="120"/>
          </a>
          <div>
            <div class="muted">Imprima o QR no folder f√≠sico para o <b>PDF completo</b>.</div>
            <div class="actions" style="margin-top:6px">
              <a id="openPdfBtn" class="btn" href="#" target="_blank" rel="noopener">üìÑ Abrir PDF</a>
              <a id="downloadPdfBtn" class="btn" href="#" download rel="noopener">‚¨áÔ∏è Baixar PDF</a>
            </div>
          </div>
        </div>
      </aside>
    </main>

    <footer class="card" style="margin-top:16px">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
        <div>Conte√∫do para <b>educa√ß√£o em sa√∫de</b>. <span class="muted">N√£o substitui avalia√ß√£o cl√≠nica. Dados locais (localStorage) e sem coleta de identifica√ß√£o.</span></div>
        <div class="actions">
          <button id="themeLight" class="btn">üåû Claro</button>
          <button id="themeDark" class="btn">üåô Escuro</button>
        </div>
      </div>
    </footer>
    <div id="printFooter" class="print-only">
      <div class="meta">
        <div>
          <div class="muted">Conte√∫do para educa√ß√£o em sa√∫de. N√£o substitui avalia√ß√£o cl√≠nica. Dados locais (localStorage) e sem coleta de identifica√ß√£o.</div>
          <div style="margin-top:6px">Autoria acad√™mica (Psicologia): <b>Laize Lemes</b>.</div>
        </div>
        <img id="printLogo" alt="Unicesumar" />
      </div>
    </div>
  </div>

  <script>
    // Utilidades b√°sicas
    const $ = (s,el=document)=>el.querySelector(s);
    const $$ = (s,el=document)=>[...el.querySelectorAll(s)];
    const store={get:(k,f)=>{try{return JSON.parse(localStorage.getItem(k)) ?? f}catch{return f}},set:(k,v)=>localStorage.setItem(k,JSON.stringify(v))};

    // Estado
    const state={goal:store.get('goal',10),minutes:store.get('minutes',0),history:store.get('history',{}),theme:store.get('theme','light')};

    // Tema
    function applyTheme(){document.documentElement.setAttribute('data-theme',state.theme==='light'?'light':'dark')}
    $('#toggle-theme').addEventListener('click',()=>{state.theme=state.theme==='light'?'dark':'light';store.set('theme',state.theme);applyTheme()});
    $('#themeLight').addEventListener('click',()=>{state.theme='light';store.set('theme',state.theme);applyTheme()});
    $('#themeDark').addEventListener('click',()=>{state.theme='dark';store.set('theme',state.theme);applyTheme()});

    // Abas
    $$('.tab').forEach(t=>t.addEventListener('click',()=>{
      $$('.tab').forEach(x=>x.setAttribute('aria-selected','false'));
      t.setAttribute('aria-selected','true');
      const target=t.getAttribute('data-target');
      $('[data-tab].active')?.classList.remove('active');
      $(target).classList.add('active');
    }));

    // QR din√¢mico e clic√°vel/baix√°vel
    function canonicalFromLocation(){
      if(location.protocol === 'https:' || location.hostname.endsWith('github.io')){
        return location.origin + location.pathname + (location.search||'');
      }
      return null;
    }
    // URLs definitivas (GitHub Pages)
    const PUBLIC_URL = 'https://fernandosilva234.github.io/Laizinha/';
    const PDF_URL = 'https://fernandosilva234.github.io/Laizinha/cartilha-viva.pdf';
    const LOGO_URL = 'https://raw.githubusercontent.com/FernandoSilva234/Laizinha/main/UNICESUMAR.jpg';

    function setQR(){
      // P√°gina p√∫blica e PDF direto hospedados no GitHub Pages
      let digitalUrl = PUBLIC_URL || canonicalFromLocation() || location.href;
      let downloadUrl = PDF_URL;
      // Se ainda n√£o h√° URL p√∫blica definida em ambiente local, usar placeholder vis√≠vel/no-op
      const srcPage = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(digitalUrl)}`;
      const srcPdf  = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(downloadUrl)}`;
      // imagens
      $('#qr').src = srcPage; $('#qr2').src = srcPdf;
      // links de clique (um para p√°gina, outro para PDF)
      $('#qrLink').href = digitalUrl; $('#qrLink2').href = downloadUrl;
      // bot√µes auxiliares
      $('#openPageBtn').href = digitalUrl;
      $('#openPdfBtn').href = downloadUrl;
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      const dl = $('#downloadPdfBtn'); dl.href = downloadUrl; if(isIOS){ dl.removeAttribute('download'); dl.target = '_blank'; }
    }

    // Progresso & streak
    function today(){return new Date().toISOString().slice(0,10)}
    function updateRing(){
      const pct = Math.min(100, Math.round((state.minutes/state.goal)*100));
      const ringEl = $('#ring');
      ringEl.style.setProperty('--p', pct);
      // Fallback para Safari muito antigo sem conic-gradient
      const supportsConic = CSS.supports('background','conic-gradient(#000 10%, #fff 0)');
      if(!supportsConic){ ringEl.classList.add('no-conic'); }
      $('#minutesDone').textContent = Math.round(state.minutes);
      $('#goal').textContent = state.goal;
      renderStreak();
    }
    function renderStreak(){
      const wrap = $('#streak'); wrap.innerHTML='';
      const weekLbl=['S','T','Q','Q','S','S','D'];
      const d=new Date(); const day=(d.getDay()+6)%7; // seg=0
      for(let i=0;i<7;i++){
        const da=new Date(); da.setDate(d.getDate()+(i-day));
        const key=da.toISOString().slice(0,10);
        const el=document.createElement('div'); el.className='dot'; el.dataset.on = !!state.history[key]?.completed; el.textContent=weekLbl[i]; el.title=key; wrap.appendChild(el);
      }
    }

    // Timer simples
    const timers=$$('[data-role="timer"]').map(el=>({el,sec:0,id:null}));
    let current=null;
    function startTimer(min,label,el){ if(current){alert('J√° existe um timer em andamento.');return} const sec=min*60; current={left:sec,el,label}; tick(); current.id=setInterval(tick,1000); $('#controls').style.display='flex' }
    function tick(){ if(!current) return; current.left=Math.max(0,current.left-1); if(current.el) current.el.textContent=fmt(current.left); if(current.left===0){ clearInterval(current.id); addMinutes(state._lastMin||0); toast('‚úîÔ∏è Bloco conclu√≠do'); celebrate(); current=null; $('#controls').style.display='none' } }
    function fmt(s){const m=String(Math.floor(s/60)).padStart(2,'0');const ss=String(s%60).padStart(2,'0');return `${m}:${ss}`}
    $('#pause').addEventListener('click',()=>{ if(current) { clearInterval(current.id); current.paused=true } });
    $('#resume').addEventListener('click',()=>{ if(current && current.paused){ current.paused=false; current.id=setInterval(tick,1000) } });
    $('#cancel').addEventListener('click',()=>{ if(current){ clearInterval(current.id); current=null; $('#controls').style.display='none'; $$('[data-role="timer"]').forEach(s=>s.textContent='00:00') } });

    $$('.start').forEach(b=> b.addEventListener('click',()=>{ const min=Number(b.dataset.min); const label=b.dataset.label; state._lastMin=min; startTimer(min,label,b.parentElement.querySelector('[data-role="timer"]')) }));

    function addMinutes(min){
      state.minutes+=min; const key=today(); const e=state.history[key]||{minutes:0,completed:false}; e.minutes=(e.minutes||0)+min; state.history[key]=e; store.set('minutes',state.minutes); store.set('history',state.history); updateRing(); if(e.minutes>=state.goal){ state.history[key].completed=true; store.set('history',state.history); renderStreak(); }
    }

    // Respira√ß√£o
    const breath=$('#breath'); $('#breathToggle').addEventListener('click',()=>{ const on=breath.getAttribute('data-active')==='true'; breath.setAttribute('data-active', on?'false':'true'); $('#breathToggle').textContent= on? 'üßò Iniciar' : '‚èπÔ∏è Parar' });

    // Exportar JSON (se bot√£o existir)
    { const btn=$('#export'); if(btn){ btn.addEventListener('click',()=>{ const data={goal:state.goal,minutes:state.minutes,history:state.history,exportedAt:new Date().toISOString()}; const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='cartilha-viva-dados.json'; a.click(); URL.revokeObjectURL(url) }); } }
    // PDF: usa fluxo de impress√£o diretamente
    $('#pdf').addEventListener('click',()=>window.print());
    // Utilit√°rio: comprimir imagem em dataURL JPEG
    async function compressImageToDataUrl(file, maxWidth=1200, quality=0.85){
      return new Promise((resolve,reject)=>{
        try{
          const url = URL.createObjectURL(file);
          const img = new Image();
          img.onload = ()=>{
            try{
              const scale = Math.min(1, maxWidth / img.width);
              const w = Math.round(img.width * scale);
              const h = Math.round(img.height * scale);
              const canvas = document.createElement('canvas');
              canvas.width = w; canvas.height = h;
              const ctx = canvas.getContext('2d');
              ctx.fillStyle = '#ffffff';
              ctx.fillRect(0,0,w,h);
              ctx.drawImage(img,0,0,w,h);
              const dataUrl = canvas.toDataURL('image/jpeg', quality);
              URL.revokeObjectURL(url);
              resolve(dataUrl);
            }catch(err){ URL.revokeObjectURL(url); reject(err); }
          };
          img.onerror = ()=>{ URL.revokeObjectURL(url); reject(new Error('Falha ao ler imagem')); };
          img.src = url;
        }catch(err){ reject(err); }
      });
    }
    // Upload de logo com compress√£o e persist√™ncia base64 (se bot√£o existir)
    { const btn=$('#uploadLogo'); if(btn){ btn.addEventListener('click',()=>{
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';
      input.onchange = async e=>{
        const file = e.target.files && e.target.files[0];
        if(!file) return;
        if(!file.type.startsWith('image/')){ toast('‚ö†Ô∏è Selecione um arquivo de imagem'); return; }
        try{
          const dataUrl = await compressImageToDataUrl(file, 1200, 0.88);
          const approxBytes = Math.ceil((dataUrl.length - 'data:image/jpeg;base64,'.length) * 3/4);
          if(approxBytes > 4.5*1024*1024){ toast('‚ö†Ô∏è Logo muito grande ap√≥s compress√£o. Tente uma imagem menor.'); return; }
          store.set('logoDataUrl', dataUrl);
          applyLogo();
          toast('üñºÔ∏è Logo atualizada');
        }catch(err){ toast('‚ö†Ô∏è Falha ao processar a imagem'); }
      };
      input.click();
    }); } }
    // Removido gerador direto: voc√™ far√° o PDF manualmente
    // Configurar URLs (se bot√£o existir)
    { const btn=$('#configUrl'); if(btn){ btn.addEventListener('click',()=>{
      const currentPublic = store.get('publicUrl','');
      const inputPublic = prompt('URL p√∫blica (GitHub Pages), ex.: https://seu-usuario.github.io/Laize/', currentPublic||'');
      if(inputPublic){ store.set('publicUrl', inputPublic.trim()); }
      const currentDownload = store.get('downloadUrl','');
      const inputDownload = prompt('URL de download (opcional, ex.: PDF). Se vazio, usamos ?print=1', currentDownload||'');
      if(inputDownload){ store.set('downloadUrl', inputDownload.trim()); } else { localStorage.removeItem('downloadUrl'); }
      setQR(); toast('üîó URLs atualizadas');
    }); } }

    // Ajustes iniciais
    (function init(){ applyTheme(); setQR(); state.goal=store.get('goal',10); $('#goalInput').value=state.goal; $('#goalInput').addEventListener('change',(e)=>{ state.goal=Math.max(5,Number(e.target.value||10)); store.set('goal',state.goal); updateRing()}); $('#celebrateDemo').addEventListener('click',celebrate); updateRing();
      // Carrega logo Unicesumar e faz fallback visual
      const logo = document.getElementById('uniLogo');
      function applyLogo(){
        const saved = store.get('logoDataUrl', null);
        if(saved){ logo.src = saved; return; }
        const sources = [
          PUBLIC_URL + 'UNICESUMAR.jpg',
          LOGO_URL,
          'https://github.com/FernandoSilva234/Laizinha/raw/Style/UNICESUMAR.jpg',
          'https://raw.githubusercontent.com/FernandoSilva234/Laizinha/Style/UNICESUMAR.jpg?raw=1',
          './UNICESUMAR.jpg','./unicesumar.jpg','./unicesumar.jpeg','./unicesumar.png',
          'unicesumar.jpg','unicesumar.jpeg','unicesumar.png'
        ];
        const show = ()=>{};
        let idx = 0;
        function tryNext(){ if(idx >= sources.length){ logo.style.display='none'; return; } logo.referrerPolicy='no-referrer'; logo.src = sources[idx++]; }
        logo.onload = show; logo.onerror = tryNext; tryNext();
      }
      // Auto-print se vier com ?print=1
      if(new URLSearchParams(location.search).get('print')==='1'){
        setTimeout(()=>{ window.print(); history.replaceState({},'',location.pathname); }, 300);
      }
      // aplica logo salva/local
      applyLogo();
    })();

    // Confete leve
    function celebrate(){ const c=$('#confetti'),x=c.getContext('2d'); const W=c.width=innerWidth,H=c.height=innerHeight,N=120,p=[]; for(let i=0;i<N;i++){ p.push({x:Math.random()*W,y:-10-Math.random()*40,r:2+Math.random()*4,vy:2+Math.random()*3,vx:(Math.random()-.5)*2,life:60+Math.random()*40,h:170+Math.random()*60}) } let f=0; const id=setInterval(()=>{ x.clearRect(0,0,W,H); p.forEach(o=>{ o.x+=o.vx;o.y+=o.vy;o.vy+=0.03;o.life--; x.beginPath(); x.fillStyle=`hsl(${o.h},80%,60%)`; x.arc(o.x,o.y,o.r,0,Math.PI*2); x.fill(); }); if(++f>100){ clearInterval(id); x.clearRect(0,0,W,H) } },16) }

    // Toast
    function toast(msg){ const el=document.createElement('div'); el.textContent=msg; el.style.cssText='position:fixed;left:50%;top:20px;transform:translateX(-50%);padding:10px 14px;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#06121d;border-radius:12px;box-shadow:var(--shadow);font-weight:800;z-index:9999'; document.body.appendChild(el); setTimeout(()=>el.remove(),1800) }
  </script>
</body>
</html>
